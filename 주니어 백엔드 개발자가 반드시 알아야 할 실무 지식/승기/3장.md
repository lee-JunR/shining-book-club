## 3장: 성능을 좌우하는 DB 설계와 쿼리


### 1. 성능에 핵심인 DB

- 실제 성능 문제의 상당 부분은 DB 설계 미숙과 비효율적 쿼리에 기인
- 특히 "풀 스캔" 같은 비효율 조회가 큰 원인
    - **풀 스캔(full scan)**: 테이블의 모든 데이터를 순차적으로 읽는 것.

### 2. 조회 트래픽을 고려한 인덱스 설계

- 인덱스는 조회 성능 향상에 핵심(일반적인 시스템에서는 조회 기능의 실행 비율이 높음)
    - **단일 인덱스**
    - **복합 인덱스**
- 인덱스 컬럼 선택 시, **선택도**(고유값 비율)가 높은 컬럼 우선 인덱스 적용
- **커버링 인덱스**(특정 쿼리를 실행하는데 필요한 컬럼 모두 포함하는 인덱스)활용하여 인덱스만으로 쿼리 처리
- 인덱스는 과도하게 사용하면 쓰기 성능 저하 가능, 꼭 필요한 것만 적용

### 3. 몇 가지 조회 성능 개선 방법

- 자주 계산되는 값은 **미리 집계**해 저장(별도 집계 테이블)
    - 요구 사항에 따라 비정규화 고려 가능
    - 데이터 최신성보다 조회 성능이 중요할 때 유용
- **ID 기반 목록 조회**(WHERE id < ?)가 OFFSET 지정(페이지 기준 목록 조회)보다 효율적
- 조회 범위 시간 기준 제한
- 전체 COUNT(*) 쿼리는 성능 저하 요인이므로 가능한 사용 자제
- 오래된 데이터는 별도 테이블로 분리하거나 삭제해 조회 부담 완화
- DB 장비 확장, 별도 캐시 서버 구성

### 4. 알아두면 좋을 몇 가지 주의 사항

- 너무 오래 걸리는 쿼리는 자원 점유 및 성능 저하 유발, 적절한 **쿼리 타임아웃** 설정으로 비정상 쿼리 차단 필요
- 복제본(DB 읽기 전용 서버)은 약간의 지연 발생 가능 (복제 지연), 실시간 상태 변경 조회는 마스터 DB에서 처리해야 데이터 일관성 보장
- 배치 작업이 길어지면 DB 부하 및 락 경합 유발하므로 병렬 처리, 적절한 커밋 단위, 인덱스 활용 등의 최적화 필요
- 조인 시 컬럼 타입 일치 및 인덱스 활성화 고려
- 테이블 컬럼 추가 등 DDL 변경은 신중히 계획 필요
- DB 커넥션 수 과다 시 자원 고갈과 성능 저하 발생, 커넥션 풀 최대 크기 설정 및 모니터링 필수

### 5. 실패와 트랜잭션 고려하기