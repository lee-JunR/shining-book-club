# 6장. 동시성, 데이터가 꼬이기 전에 잡아야 한다

## 이 장에서 다룰 내용
- 동시성 문제
- 잠금을 이용한 동시 접근 제어
- 원자적 타입과 동시성 지원 컬렉션
- DB와 동시성: 선점 잠금과 비선점 잠금
- 잠금 주의 사항

---

## 서버와 동시 실행
서버는 여러 클라이언트 요청을 동시에 처리해야 하며, 다음 두 가지 방식이 있다.
1. 클라이언트 요청마다 **스레드를 할당**하여 처리
2. **비동기 I/O (논블로킹 I/O)**를 이용해 처리

### 경쟁 상태 (Race Condition)
- 여러 스레드가 동시에 **공유 자원에 접근**할 때, 접근 순서에 따라 결과가 달라지는 현상.
- 경쟁 상태가 발생하면 **예상치 못한 결과나 오류**가 생길 수 있다.

---

## 프로세스 수준에서의 동시 접근 제어

### 잠금(Lock)을 이용한 접근 제어
**잠금을 사용하는 일반적인 흐름**
1. 잠금을 획득 (한 번에 한 스레드만 가능)
2. 공유 자원 접근 (임계 영역, Critical Section)
3. 잠금 해제

> 💡 **임계 영역(Critical Section)**  
> 동시에 두 개 이상의 스레드가 접근하면 안 되는 공유 자원 접근 구간.

---

### synchronized와 ReentrantLock
- **synchronized**
   - 간단하게 스레드의 동시 접근을 제어할 수 있는 방법.
   - `unlock()` 호출이 필요 없음.
- **ReentrantLock**
   - 잠금 획득 대기 시간을 지정할 수 있는 기능 제공.
   - (Java 24버전부터 지원)

---

### 뮤텍스(Mutex)
- “Mutual Exclusion(상호 배제)”의 줄임말로, **잠금(lock)**과 동일한 개념.
- 언어나 시스템에 따라 ‘뮤텍스’ 혹은 ‘락’이라는 용어를 사용.

---

## 동시 접근 제어를 위한 구성 요소

### 1. 세마포어 (Semaphore)
- 동시에 실행 가능한 **스레드 수를 제한**.
- **이진 세마포어**: 1개의 스레드만 접근 가능.
- **계수 세마포어**: 지정된 수만큼 스레드 접근 가능.
- 자바에서는 **퍼밋(permit)** 개념으로 구현됨.

**사용 흐름**
1. 퍼밋 획득 → 허용 가능한 숫자 1 감소
2. 코드 실행
3. 퍼밋 반환 → 허용 가능한 숫자 1 증가

---

### 2. 읽기-쓰기 잠금 (ReadWriteLock)
- **쓰기 잠금**
   - 한 번에 하나의 스레드만 접근 가능.
- **읽기 잠금**
   - 여러 스레드가 동시에 접근 가능.
- **상호 배제 규칙**
   1. 쓰기 잠금 중에는 읽기 잠금 불가.
   2. 읽기 잠금 중에는 쓰기 잠금 불가.
   3. 모든 읽기 잠금이 해제되어야 쓰기 잠금 획득 가능.

---

## 원자적 타입(Atomic Type)
- **AtomicInteger, AtomicLong, AtomicBoolean** 등은  
  여러 스레드가 동시에 접근해도 **데이터 충돌 없이** 안전하게 값 변경이 가능.
- 내부적으로 **CAS(Compare-And-Swap)** 연산을 통해 구현됨.

---

## 동시성 지원 컬렉션
- 자바의 `Collections` 클래스에서 제공하는 컬렉션은  
  데이터를 변경할 때마다 **잠금을 적용**하여 한 번에 한 스레드만 접근 가능.
- **ConcurrentHashMap**
   - 전체가 아닌 부분 잠금으로, 성능을 높이면서도 안전성을 유지.

### 불변(Immutable) 값
- 동시성 문제를 피하기 위한 대표적인 방법.
- 값이 변하지 않기 때문에 동시에 접근해도 충돌이 발생하지 않는다.
- 예: **CopyOnWriteArrayList**
   - 요소 추가/삭제 시마다 **새로운 리스트를 생성**해 반환.

---

## 💡 요약
- 동시성 문제는 **여러 스레드가 같은 데이터를 동시에 변경하려 할 때 발생**한다.
- 이를 막기 위해 **잠금(Lock)**, **세마포어(Semaphore)**, **읽기-쓰기 잠금** 등을 사용한다.
- 가능하면 **원자적 타입**과 **불변 객체**를 활용하여 충돌 가능성을 줄인다.
- **Concurrent 컬렉션**은 잠금 범위를 최소화하여 동시성과 성능을 모두 확보할 수 있다.


