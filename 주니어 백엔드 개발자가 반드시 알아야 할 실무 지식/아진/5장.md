# 5장. 비동기 연동, 언제 어떻게 써야 할까

## 다룰 내용
- 비동기 연동
- 별도 스레드를 이용한 비동기 연동
- 메시징을 이용한 비동기 연동
- 트랜잭션 아웃박스 패턴
- 배치 전송
- CDC(Change Data Capture)

---

## 동기 연동과 비동기 연동
- **동기 방식**은 외부 서비스의 응답 시간까지 고려해야 하므로 전체 처리 시간이 길어진다.
- **비동기 방식**은 한 작업이 끝나길 기다리지 않고 다음 작업을 바로 처리한다.  
  → 외부 연동이 끝날 때까지 기다리지 않아 효율적이다.

---

## 별도 스레드로 실행하기
- 스프링에서는 `@Async` 애노테이션으로 메서드를 비동기로 실행할 수 있다.
- 별도 스레드에서 실행되는 코드는 발생한 오류를 내부에서 직접 처리해야 한다.

### 스레드와 메모리
- **스레드 풀**을 사용하면 스레드 개수를 일정하게 유지하여 메모리 사용량을 제어할 수 있다.  
  단, 풀에 있는 스레드보다 많은 작업이 동시에 실행되면 일부는 대기하게 된다.
- **가상 스레드**나 **고루틴**은 런타임에서 관리하는 경량 스레드로, 적은 메모리를 사용한다.  
  → 외부 API 호출이나 DB 연동 같은 네트워크 I/O 작업에 적합하다.

---

## 메시징
- 메시징 시스템을 사용하면 구조는 복잡해지지만 다음과 같은 이점이 있다.
  1. 시스템 간 영향이 적다.
  2. 확장이 용이하다.
- 대표 기술: **Kafka**, **RabbitMQ**, **Redis Pub/Sub**

### 메시지 생성 측 고려사항
- **메시지 유실** 방지 필요
- **타임아웃** 발생 시 처리 방법:
  1. 무시
  2. 재시도
  3. 실패 로그 남김
- 메시지 생산자는 DB 트랜잭션과 연동도 고려해야 한다.

#### 글로벌 트랜잭션과 메시지 연동
- **글로벌 트랜잭션**: 여러 DB를 하나의 트랜잭션으로 묶어 처리하는 방식
- **ActiveMQ**는 글로벌 트랜잭션을 지원하며, DB 수정과 메시지 전송을 한 트랜잭션으로 묶을 수 있다.  
  → 메시지 전송 실패 시 DB 롤백, DB 롤백 시 메시지 취소 가능  
  → 단점: 2단계 커밋 과정으로 처리 속도 저하

### 메시지 소비 측 고려사항
- 동일 메시지가 중복 처리될 수 있음  
  (생산자가 중복 전송하거나, 소비자 처리 중 오류 발생 시 재수신되는 경우)

### 메시지 종류: 이벤트와 커맨드
- **이벤트(Event)**: 어떤 일이 발생했음을 알림. 정해진 수신자가 없음.  
  → 관심 있는 소비자만 메시지를 수신하므로 확장성에 유리.
- **커맨드(Command)**: 특정 수신자에게 요청을 전달하는 메시지.

#### 궁극적 일관성(Eventual Consistency)
- 분산 시스템에서 즉시가 아닌 일정 시간이 지난 후 데이터 일관성이 맞춰지는 모델.
- 비동기 메시징도 이러한 특성을 가진다.  
  → 일시적 불일치는 가능하지만, 결국 일관성이 유지된다.

---

## 트랜잭션 아웃박스 패턴
- 메시지를 DB에 안전하게 저장한 뒤, 별도 프로세스가 이를 읽어 메시징 시스템에 전송하는 방식.
1. 실제 업무 로직을 처리하며 DB 변경 수행
2. 메시지를 **아웃박스 테이블**에 추가
3. 별도의 중계 프로세스가 주기적으로 테이블을 읽어 메시지 전송  
   → 메시지 손실을 방지하면서 비동기 연동 구현 가능

---

## 배치 전송
- 데이터를 일정 간격으로 모아 **비동기로 전송**하는 방식
### 실행 과정
1. DB에서 전송할 데이터를 조회
2. 결과를 파일로 기록
3. 파일을 연동 시스템에 전송

- 파일 전송은 **FTP**, **SFTP**, **SCP** 등을 이용한다.
- 파일 형식:
  1. 구분 문자로 값 구분
  2. 이름=값 쌍
  3. JSON 형식의 라인 단위 데이터

### 소비자 동작 방식
1. 지정 경로에서 파일 존재 여부 확인
2. 파일이 있으면 데이터를 읽고 시스템에 반영
3. 없으면 후처리
4. 처리 완료 후 파일을 다른 폴더로 이동

---

## CDC (Change Data Capture)
- **CDC**는 변경된 데이터를 추적해 그 변경 내용을 다른 시스템으로 전달하는 설계 패턴이다.
- `INSERT`, `UPDATE`, `DELETE` 쿼리 실행 시 변경된 DB 데이터를 **CDC 처리기**로 전송  
  → DB는 커밋된 데이터만 전달하고, 롤백된 데이터는 제외된다.
- CDC 처리기는 전달받은 데이터를 확인·가공해 대상 시스템에 전파한다.
  1. 변경 데이터를 그대로 전달
  2. 데이터를 가공/변환 후 전달  
     → 실시간 동기화나 이벤트 기반 시스템에 적합하다.
