# 2장. 느려진 서비스, 어디부터 봐야 할까

## 처리량과 응답 시간

### 응답 시간
- 응답 시간을 줄일 때는 **DB 연동**과 **API 연동 시간**에 집중한다.

### 처리량 (TPS: Transactions Per Second)
- 응답 시간 증가를 방지하려면 TPS를 높여야 한다.
- TPS를 높이는 방법
  1. 서버가 동시에 처리할 수 있는 요청 수를 늘려 대기 시간 줄이기
  2. 처리 시간 자체를 줄여 대기 시간 줄이기
- TPS는 **스카우터, 핀포인트, 뉴렐릭** 등의 모니터링 시스템으로 확인할 수 있다.

---

## 서버 성능 개선 기초

### 병목지점
- 시스템이 수용할 수 있는 최대 TPS를 초과하는 트래픽이 유입되면 성능 문제가 발생한다.  
  → 따라서 **최대 TPS를 높이는 것**이 필요하다.

### 수직 확장과 수평 확장
- **수직 확장 (Scale-up)**
  - CPU, 메모리, 디스크 등 자원을 증가시킨다.
  - 응답 시간을 줄이고 처리량을 높일 수 있다.
- **수평 확장 (Scale-out)**
  - 서버를 추가로 투입하여 TPS를 높이는 방법.
  - 단, DB나 외부 API에 성능 문제가 없는 범위 내에서만 효과적이다.

### DB 커넥션 풀
- DB에 연결된 커넥션을 미리 생성해 보관하고, 필요할 때 꺼내 쓰고 반환한다.
- 장점: 이미 연결된 커넥션을 재사용 → 응답 시간 단축.
- 중요 포인트
  - **풀 크기 설정**: 서버는 DB와 통신을 많이 하기 때문에 가장 중요한 설정.
  - **대기 시간**: 풀에 커넥션이 없을 때, 커넥션을 얻기 위해 기다릴 수 있는 최대 시간.
  - **최대 유휴 시간**: 사용되지 않는 커넥션을 풀에 유지할 수 있는 최대 시간.
  - **유효성 검사**: 끊긴 커넥션을 사용해 발생하는 에러를 방지하기 위해 커넥션이 정상인지 확인.

### 서버 캐시

- DB 서버를 확장하지 않고도 응답 시간과 처리량을 개선할 수 있는 방법 → **캐시 활용**.

### 적중률과 삭제 규칙
- **적중률** = 캐시에 존재한 건수 ÷ 캐시 조회 시도 건수.
- 적중률이 높을수록 DB 연동이 줄어들고, 응답 시간 감소, 처리량 증가, DB 부하 감소 효과.
- 오래된 데이터는 사용될 확률이 낮기 때문에 삭제하여 메모리를 효율적으로 사용해야 한다.

### 로컬 캐시와 리모트 캐시
- **로컬 캐시 (In-memory 캐시)**
  - 서버 프로세스와 동일한 메모리를 캐시 저장소로 사용.
  - 장점: 속도가 빠르고 구조가 단순.
  - 단점: 데이터 크기에 제한이 있고, 서버 재시작 시 캐시 효율(적중률)이 순간적으로 떨어짐.
  - 사용 사례: 보관할 데이터 규모가 작고 변경 빈도가 매우 낮을 때 (예: 게시글 목록).

- **리모트 캐시**
  - 별도 프로세스를 캐시 저장소로 사용 (Redis, Memcached 등).
  - 장점: 캐시 크기를 유연하게 확장 가능.
  - 단점: 속도가 느리고 시스템 구조가 복잡.
  - 사용 사례: 데이터 규모가 크고 변경 관리가 필요한 경우 (예: 대형 쇼핑 사이트).

### 캐시 사전 적재
- 트래픽이 순간적으로 급증하는 패턴이 보일 경우, 데이터를 미리 캐시에 저장하여 안정적인 응답 시간을 유지하고 DB 부하 집중을 방지한다.

### 캐시 무효화
- 유효하지 않은 데이터를 적절한 시점에 캐시에서 삭제해야 한다.
- **변경에 민감한 데이터** → 리모트 캐시에 보관.
- **변경에 민감하지 않고 데이터 크기가 작은 경우** → 캐시 유효 시간(TTL)을 설정해 주기적으로 갱신.

### 가비지 컬렉터와 메모리 사용

- 가비지 컬렉터를 사용하는 언어는 사용이 끝난 객체를 힙 메모리에서 바로 삭제하지 않고, 정해진 규칙에 따라 사용하지 않는 메모리를 찾아 반환한다.
- 주의 사항
  - 한번에 대량 객체 생성 주의.
  - 대량 객체 생성을 방지하기 위해 **조회 범위 제한** 필요.
  - 파일 다운로드 같은 기능은 **스트림**을 활용 → 처리 과정에서 필요한 메모리 크기 절감.

### 응답 데이터 압축

- 응답 시간에는 **네트워크 전송 시간**이 포함된다.
- 전송 시간은 **네트워크 속도**와 **전송 데이터 크기**의 영향을 받음.
- 데이터를 압축해 전송하면 전송 속도가 빨라지고 응답 시간이 짧아진다.

### 정적 자원과 브라우저 캐시

- **정적 자원**: 같은 URL에 대해 동일한 데이터를 응답하는 콘텐츠(이미지, JS, CSS).
- 클라이언트 캐시를 활용하면 트래픽을 줄이고, 브라우저가 화면을 더 빠르게 표시할 수 있다.

### 정적 자원과 CDN

- 브라우저 캐시만 사용하면 사용자 수가 많아질 때 네트워크가 포화되어 응답 시간이 급격히 느려질 수 있다.
- 해결책: **CDN(Content Delivery Network)** 활용.
  1. CDN이 제공하는 URL을 통해 콘텐츠에 접근.
  2. CDN 서버에 요청한 콘텐츠가 없으면 오리진 서버에서 가져와 제공.
  3. 오리진 서버에서 가져온 콘텐츠는 CDN 캐시에 보관.
  4. 이후 동일한 콘텐츠 요청 시 오리진 서버는 한 번만 처리.
- 결과: 오리진 서버가 처리해야 할 트래픽을 크게 줄일 수 있다.

### 대기 처리

- 트래픽이 순간적으로 증가할 때, 동시에 수용할 사용자 수를 제한하고 나머지 사용자를 대기 처리.
- 장점
  - 서버 증설 없이도 서비스를 안정적으로 제공 가능.
  - 사용자가 새로고침할 경우 순번이 밀리기 때문에 불필요한 새로고침 감소 → 트래픽 폭증 방지.
