# 3장. 성능을 좌우하는 DB 설계와 쿼리

## 성능에 핵심인 DB
- **풀 스캔**: 테이블의 모든 데이터를 순차적으로 읽는 것. (WHERE 절 조건에 맞는 인덱스가 없을 때 발생)
- DB 성능은 단순히 DB만의 문제가 아니라 **연동하는 모든 서버 성능에 영향을 준다.**

---

## 조회 트래픽을 고려한 인덱스 설계
- DB 테이블을 설계할 때는 **조회 기능**과 **트래픽 규모**를 반드시 고려해야 한다.
- **풀 스캔을 방지**하려면 조회 패턴을 기준으로 인덱스를 설계해야 한다.

### 단일 인덱스와 복합 인덱스
- 단일 인덱스로는 성능 개선이 제한적일 수 있다.
- 여러 칼럼을 포함한 **복합 인덱스**를 적용하면, 인덱스에 포함된 값만으로 쿼리 결과를 빠르게 구할 수 있다.

### 선택도를 고려한 인덱스 칼럼 선택
- **선택도**: 인덱스 칼럼에서 고유한 값의 비율.
    - 선택도가 높음 → 고유 값이 많음 → 조회 효율 ↑
    - 선택도가 낮음 → 고유 값이 적음 → 조회 효율 ↓
- 단, 선택도가 낮아도 인덱스 칼럼으로 적합한 경우가 있음.  
     ``` 
  create table jobqueue (
  jobid varchar(16) not null primary key,
  status char(1) not null,
  --생략
  )
    ```
  예: `status` 칼럼(W, P, C 세 가지 값) → 고유 값은 적지만 자주 조회 조건에 쓰이므로 인덱스 효과 있음.

### 커버링 인덱스 활용
- **커버링 인덱스**: 특정 쿼리 실행에 필요한 칼럼을 모두 포함한 인덱스.
- 커버링 인덱스를 활용하면 실제 테이블 접근 없이 인덱스만으로 쿼리 처리가 가능해져 성능이 크게 향상된다.

### 인덱스는 필요한 만큼만
- 장점: 조회 속도를 빠르게 한다.
- 단점: 데이터 추가, 변경, 삭제 시 인덱스 관리 비용(시간)이 증가한다.
- 같은 컬럼에 중복 인덱스를 추가하는 것은 불필요하며, 성능 저하를 유발할 수 있다.
- 따라서 인덱스 생성 전 **존재 여부와 필요성**을 반드시 확인해야 한다.

---

## 몇 가지 조회 성능 개선 방법

### 미리 집계하기
- `COUNT`, `SUM`과 같은 집계 쿼리를 매번 실행하는 대신, **집계 데이터를 미리 계산해 별도 칼럼에 저장**하는 방식.
- 데이터 불일치가 약간 발생할 수 있지만, 실시간 집계보다 훨씬 효율적일 수 있다.  
  예: 설문 응답 수, 특정 조건별 카운트.

### 조회 범위를 시간 기준으로 제한하기
1. 조회 범위를 **일자 기준으로 제한** → 쿼리가 단순해지고 성능 문제 예방.
2. **최신 데이터 위주 조회** → 불필요한 과거 데이터 접근을 줄여 성능 개선.

### 오래된 데이터 삭제 및 분리 보관하기
- 과거 데이터를 삭제하거나 별도 보관소로 옮겨서 **데이터 개수를 일정하게 유지** → 성능 유지 가능.
- 단점: `DELETE` 과정에서 빈 공간이 생겨 **단편화(fragmentation)** 발생 가능.
- 해결책: **최적화 작업**(데이터 재배치)으로 단편화 해소 및 디스크 사용량 절감.

### DB 장비 확장하기
1. **클라우드 확장**: 손쉽게 DB 장비 성능(CPU, 메모리, 디스크)을 높일 수 있다.
2. **수평 확장**: 여러 DB 서버를 두어 트래픽을 분산 처리한다.

### 별도 캐시 서버 구성하기
- Redis 같은 **캐시 서버**를 두면 DB 확장 대비 적은 비용으로 더 많은 트래픽 처리 가능.
- DB 부하 감소, 응답 속도 향상, 안정적인 서비스 운영에 효과적.

---

## 알아두면 좋은 주의 사항

### 쿼리 타임아웃
- 응답 지연 시 재시도가 발생하면 서버 부하가 폭증할 수 있다.
- **쿼리 실행 시간을 제한(타임아웃 설정)**하여 재시도로 인한 부하 폭증을 방지한다.

### 상태 변경 기능은 복제 DB에서 조회하지 않기
- **복제 DB 문제점**
    1. 주 DB와 복제 DB 간 데이터가 순간적으로 불일치할 수 있다.
        - 주 DB에서 변경 → 네트워크 전송 → 복제 DB 반영 과정에서 지연 발생.
    2. 트랜잭션 불일치 발생 가능.

→ 따라서 **상태 변경과 관련된 기능은 복제 DB에서 조회하지 않는 것이 원칙**이다.

### 배치 쿼리 실행 시간 증가
- 배치 작업에서 사용하는 쿼리 실행 시간이 점점 늘어나는 현상에 주의.
- 해결 방법:
    1. 배치 쿼리 실행 시간을 지속적으로 추적.
    2. DB 장비 성능 업그레이드.
    3. 데이터를 일정 크기로 나누어 처리.
    4. 짧은 간격으로 분할 집계 실행.

---

## 실패와 트랜잭션 고려하기
- 트랜잭션의 **시작과 종료 경계**를 반드시 명확히 해야 한다.
- 실패 상황에서 데이터 불일치를 막기 위해 롤백과 같은 **예외 처리**도 고려해야 한다.
