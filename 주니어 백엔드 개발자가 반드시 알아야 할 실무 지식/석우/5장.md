# 5장 정리

## 5장 비동기 연동, 언제 어떻게 써야 할까.

- 비동기 연동
- 별도 스레드를 이용한 비동기 연동
- 메시징을 이용한 비동기 연동
- 트랜잭션 아웃박스 패턴
- 배치 전송
- CDC

### ** 비동기 연동, 언제 어떻게 써야 할까 정리**

```
전통적인 동기(Synchronous) 방식은 작업이 순차적으로 실행되어 프로그램 흐름을 이해하기 쉽고 디버깅이 용이합니다. 그러나 외부 서비스를 호출할 때 연동 서비스의 응답이 지연되거나 장애가 발생하면 전체 기능의 실행이 중단되거나 응답 시간이 길어지는 문제(성능 저하)가 발생할 수 있습니다.

비동기(Asynchronous) 방식은 한 작업이 끝날 때까지 기다리지 않고 다음 작업을 바로 처리합니다. 이를 통해 외부 연동 시간에 관계없이 사용자에게 빠르게 응답을 제공할 수 있으며, 연동 서비스의 일시적인 문제로 인해 전체 서비스의 응답 시간이 증가하는 것을 방지합니다.
```

> 비동기 연동을 고려해야 할 시점

1. 시차 허용: 연동에 약간의 시차가 생겨도 서비스 운영에 큰 문제가 없는 경우 (예: 주문 완료 후 판매자에게 푸시 발송)

2. 재시도 가능: 연동 실패 시 재시도를 통해 성공 확률을 높일 수 있는 경우 (예: 포인트 지급 실패 후 재시도)

3. 수동 처리 가능: 연동 실패 시 나중에 관리 툴 등을 통해 수동으로 처리하여 데이터 일관성을 맞출 수 있는 경우

4. 실패 무시 가능: 연동에 실패하더라도 핵심 기능 동작에는 문제가 없어 실패를 무시해도 되는 경우 (예: 주문 알림 푸시)

> 비동기 연동의 5가지 구현 방식

1. 별도 스레드
   새로운 스레드, 스레드 풀, 또는 프레임워크 기능(@Async)을 사용하여 비동기로 실행
   가장 간단하지만, 연동 중 발생한 오류를 직접 처리해야 하며 (익셉션 전파 불가), 스레드 생성 비용과 메모리 사용을 고려해야 함 (경량 스레드 권장)

2. 메시징 시스템
   시스템 A와 B 사이에 메시징 시스템(카프카, 래빗MQ 등)을 두어 메시지를 주고받음
   두 시스템 간의 영향을 최소화하고, 확장이 용이함. 메시지 유실, 순서 보장, 중복 처리 (멱등성) 등을 고려해야 함

3. 트랜잭션 아웃박스 패턴
   실제 DB 변경 작업과 메시지 데이터를 아웃박스 테이블에 추가하는 작업을 하나의 DB 트랜잭션으로 묶음
   DB 트랜잭션의 일관성 보장. 메시지 중계 프로세스가 주기적으로 DB를 읽어 메시징 시스템에 전송

4. 배치 전송
   일정 간격(예: 1시간, 다음 날)으로 데이터를 일괄 조회하고 파일(FTP/SFTP)이나 API로 전송
   데이터를 비동기로 연동하는 가장 전통적인 방법. 전송 실패 시 재처리 기능 구현이 중요

5. CDC (Change Data Capture)
   DB의 데이터 변경분을 추적하여 대상 시스템에 전파
   기존 시스템의 코드 수정 없이 연동 가능. 이벤트 메시지와 유사하나 정확한 의미는 변경분을 통해 도출해야 함

#### 결론

비동기 연동은 외부 시스템과의 상호작용이 잦은 현대 서버 환경에서 성능, 안정성, 자율성을 확보하는 데 유리한 설계 기법입니다.

외부 연동이 전체 서비스 응답 시간을 지연시키는 주요 병목 지점일 경우 비동기 방식을 적용하여 응답 시간을 단축하고 처리량을 개선할 수 있습니다.

다만 비동기 구현은 구조가 더 복잡해지고 두 시스템 간에 데이터가 일시적으로 불일치하는 궁극적 일관성을 갖게 되므로 개발자가 신경 써야 할 부분이 많아집니다.

따라서 모든 연동을 비동기로 구현할 필요는 없으며 구조 복잡도 증가 비용 대비 얻는 이점이 클 때 그리고 특히 DB 트랜잭션 일관성이 중요할 때는 트랜잭션 아웃박스 패턴과 같이 안정성을 높이는 방식을 함께 고려하여 신중하게 도입해야 합니다.
