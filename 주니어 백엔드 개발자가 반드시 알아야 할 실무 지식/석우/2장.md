# 2장 정리

## 2장 느려진 서비스, 어디부터 봐야 할까.

> 처리량과 응답 시간

- 성능 저하의 가장 큰 특징으로 클라이언트에 결과 표시가 늦거나 타임아웃 발생
- 서버 서능의 핵심 지표로는 요청을 처리하는데 걸린 시간(응답 시간), 일정 시간 동안 처리할 수 있는 요청 수(처리량)

> 병목 지점과 확장

- 서비스 초기에는 성능 문제가 잘 없지만, 트래픽과 데이터가 늘어나면서 점차 응답 지연이 발생할 수 있다. 증상으로는 모든 요청의 응답 시간이 느려지고, 서버 재시작 시 잠시 정상으로 보이다가 시간이 지나면서 느려지는 경우가 있는데 원인으로는 시스템이 처리할 수 있는 최대 TPS(Transactions Per Second) 시스템이 1초당 처리할 수 있는 작업의 수를 초과했기 때문에 발생한다.
- 성능 개선 방법으로는 수직 확장과 수평 확장으로 나눠지며 수직 확장에는 CPU, 메모리, 디스크 성능을 높이는 방법이 있지만 비용이 크고 장비 한계가 있어 한계적이며 시간 벌기 위한 임시 해결이 될 수도 있다. 수평 확장으로는 서버를 여러 대 두고 로드밸런서(사용자 트래픽을 각 서버에 골고루 분배해서 한 서버에 사용자 트래픽이 몰리지 않도록 하는 역할)를 통해 트래픽을 분산 정적 방식(라운드 로빈, IP 해시)과 동적 방식(연결 수, 응답 시간 기반 분배)가 있다.

> DB 커넥션 풀

##### 1. DB 연결 과정의 비용

- DB를 매번 연결하고 끊는 과정은 0.5~1초 이상 걸릴 수 있어, 실제 쿼리 실행 시간보다 더 큰 지연을 만들 수 있고 전체 응답 시간의 대부분이 DB 연결/종료에 쓰이면 처리량이 급격히 떨어진다.

##### 2. 커넥션 풀의 필요성

- 커넥션 풀은 DB와 미리 연결을 맺어둔 커넥션을 보관하고 재사용하는데 이를 통해 연결 비용을 줄이고 응답 속도와 처리량을 크게 개선할 수 있고 대부분의 프레임워크가 커넥션 풀을 기본으로 지원한다.

##### 3. 주요 설정 항목

- 풀 크기 : 최소/최대 커넥션 개수를 지정
- 대기 시간 : 커넥션이 없을 때 기다리는 최대 시간
- 최대 유휴 시간 : 사용하지 않는 커넥션을 유지하는 시간
- 유효성 검사 : 커넥션이 정상인지 확인하는 절차(간단 쿼리 실행)
- 최대 유지 시간 : 커넥션의 최대 생존 시간. 일정 시간이 지나면 강제로 종료

> 서버 캐시

##### 1. 캐시 기본 원리

- 자주 조회되는 데이터, 계산 결과, 외부 API 응답을 캐시에 저장하면 DB 조회 없이 빠르게 응답 가능하다. 캐시 적중률이 높을수록 응답 시간 단축, 처리량 증가, DB 부하 감소 효과가 크다

##### 2. 캐시 운영 핵심

- 적중률 관리 : 데이터를 많이 캐싱할수록 적중률은 올라가지만 메모리 한계로 삭제 규칙(LRU, LFU, FIFO)과 만료 시간(TTL)을 활요
- 캐시 종류 : 로컬 캐시(속도가 빠르지만 메모리 제한 서버 재시작 시 초기화 문제), 리모트 캐시(Redis 등 확장성과 안정성이 높지만 네트워크 통신)
- 사용 기준 : 소규모, 변경이 적으면 로컬 캐시 / 대규모, 변경이 많으면 리모트 캐시
- 사전 적재 : 트래픽 폭증(ex.푸시 알람 후 동시 접속) 전에 캐시에 미리 데이터를 넣어두면 안정적 응답 유지
- 캐시 무효화 : 원본 데이터 변경 시 즉시 갱신하거나 TTL로 주기적 갱신, 민감한 데이터는 리모트 캐시를 사용해서 서버 간 불일치 문제를 피할 수 있다.

##### 3. 메모리 관리와 GC

- GC는 자동 메모리 관리를 돕지만 실행 시 응답 시간 지연이 발생할 수 있다.
- 메모리 사용량이 많거나 대량 객체를 한 번에 생성하면 GC 부담이 커져 성능 저하 OOM 에러로 이어질 수 있다. 개선 방법으로는 메모리 제한 조정, 조회 범위 제한, 스트림 처리로 대량 객체 로딩 방지가 있다.

##### 4. 응답 데이터 압축

- 네트워크 속도는 제어 불가하지만 전송 데이터 크기는 줄일 수 있는데, HTML CSS JS JSON 같은 텍스트 데이터는 압축 시 70% 이상 크기 절감이 가능하고 전송 시간 비용 모두 절약이 가능하다.

> 정적 자원과 캐시/CDN

##### 1. 브라우저 캐시 한계

- 브라우저 캐시는 사용자 단위로만 동작하기 때문에 동시에 많은 사용자가 접속하면 이미지 JS CSS 같은 정적 자원이 대량 전송되며 이때 네트워크 대역폭이 포화되어 응답 시간이 급격히 늘어난다.

##### 2. CDN 개념과 동작 원리

- CDN(Content Delivery Network)는 전 세계에 분산된 서버를 통해 콘텐츠를 캐싱하고 제공하는 네트워크이며 사용자는 지리적으로 가까운 서버에 연결해 콘텐츠를 받으므로 빠르고 효율적으로 전달된다.

##### 3. CDN 장점

- 서버의 트래픽 감소
- 콘텐츠 제공 속도 향상
- 트래픽 비용 절감

> 대기 처리

##### 1. 순간적 트래픽 증폭

- 대표적으로 콘서트 예매, 한정판 판매 같이 짧은 시간에만 트래픽이 폭증하는 경우가 있고 이런 상황에서 서버와 DB를 단순 증설하는 방법은 가능하지만 비용 부담이 크다. 특히 DB는 증설 후 다시 줄이기가 어렵다.

##### 2. 대기 처리 방식

- 처리량을 무한히 늘리려 하지 않고 수용 가능한 트래픽까지만 받아들이고 나머지는 대기열에 넣는 방식을 사용

##### 3. 대기 처리의 장점

- 서버/DB를 무리하게 증설하지 않고도 안정적으로 서비스 제공 가능
- 사용자 새로 고침 폭주 방지, 새로 고침하면 오히려 순번이 뒤로 밀리므로 불필요한 요청이 줄어듦
- 사용자는 기다리더라도 결국 서비스를 이용할 수 있음

## 결론

```
- 서비스 성능 최적화의 핵심은 DB,외부 API 중심의 응답 시간 관리
- DB 커넥션 풀과 캐시,메모리 최적화
- CDN을 통한 정적 자원 분산 제공
- 폭증 트래픽에 대한 대기열 처리
```
