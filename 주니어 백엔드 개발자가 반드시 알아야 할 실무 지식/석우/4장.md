# 4장 정리

## 4장 외부 연동이 문제일 때 살펴봐야할 것들.

- 외부 연동 문제
- 타임아웃과 재시도
- 동시 요청 제한과 서킷 브레이커
- DB와 외부 연동
- HTTP 커넥션 풀
- 이중화

### **외부 연동이 문제일 때 살펴봐야할 것들 정리**

> 외부 연동 문제란?

- 우리 서비스(A)가 다른 서비스(B)에 의존할 때 B가 느려지거나 장애가 발생하면 A도 같이 마비될 수 있다.
- A은행 사례처럼 우리 서버는 멀쩡하지만 외부 인증 서버가 느려서 장애 발생하는 케스가 대표적인 예시로 나온다.

> 타임아웃 설정은 필수

- 외부 서비스가 응답을 안 주면 A 서비스의 스레드가 전부 기다림 상태가 되면 전체 요청이 멈추는 증상이 발생 타임아웃 설정으로 일정 시간 내 응답이 없으면 에러를 반환하고 종료하는 방법으로 해결 가능

> 재시도 (Retry)

- 네트워크는 불안정하므로 일시적인 실패는 재시도하면 성공할 수 있음 단 멱등성을 가진 요청만 재시도해야 한다. 멱등성이란? 동일한 연산을 여러 번 적용해도 결과가 변하지 않는 성질을 의미

> 동시 요청 제한

- 외부 서비스(B)가 동시에 처리 가능한 요청이 100개인데 300개가 몰리면 전체가 느려지는데 B로의 동시 요청 수를 제한하고 초과 시 바로 에러(503)을 반환

> 서킷브레이커

- 외부 연동에 반복적으로 실패하면 일정 시간 요청 자체를 차단하고 바로 실패 응답을 준다.
- 외부 서비스가 회복되면 자동으로 다시 열림

```
상태 변화
- CLOSED (닫힘): 정상적인 상태로, 서비스 호출을 정상적으로 수행합니다. 서비스 호출 실패율이 일정 임계치에 도달하면 Open 상태로 전환

- OPEN (열림): 서비스 호출 실패가 임계치를 넘어섰을 때 전환되는 상태입니다. 이 상태에서는 해당 서비스로의 모든 요청을 즉시 실패 처리하여, 실패한 서비스가 복구될 시간을 벌어준다.

- HALF-OPEN (반-열림): 일정 시간이 지나면 이 상태로 전이됩니다.
조치: 소수의 요청을 실제 서비스로 전달하여 해당 서비스의 상태를 확인합니다. 성공적인 응답이 발생하면 다시 CLOSED 상태로 돌아가고, 실패하면 다시 OPEN 상태로 전환
```

> 외부 연동 + DB 트랜잭션 주의점

- 트랜잭션 안에서 외부 연동이 느려지면 DB 커넥션이 오래 점유되어 풀 부족 발생하는데 가능하면 외부 연동을 트랜잭션 밖에서 실행하거나 DB 연동 후 처리하도록 순서 조정이 필요

#### 결론

외부 연동은 서비스 장애의 가장 흔한 원인 중 하나다.

우리 서버가 아무리 정상이어도, 외부 API나 인증 서버, 결제 서버가 느려지거나 멈추면 전체 서비스가 마비될 수 있다.

따라서 빠르게 실패하고 안전하게 복구하는 구조가 핵심이다.

타임아웃을 통해 응답 대기 시간을 제한하고 일시적 실패는 재시도로 복구하되 멱등성을 보장해야 한다.

서킷브레이커와 동시 요청 제한은 장애 전파를 막는 방어선이며 DB 트랜잭션 안에서 외부 호출을 실행하는 것은 피해야 한다.

즉 외부 연동 설계의 본질은 외부 장애가 내 시스템까지 전파되지 않게 하는 것이다.
